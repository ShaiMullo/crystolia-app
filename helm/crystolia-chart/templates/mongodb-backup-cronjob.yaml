{{- if .Values.mongodb.backup.enabled }}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: mongodb-backup
  labels:
    app: mongodb-backup
spec:
  schedule: {{ .Values.mongodb.backup.schedule | quote }}
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: mongodump
              image: mongo:6.0
              command:
                - /bin/sh
                - -c
                - |
                  set -e
                  TIMESTAMP=$(date +%Y%m%d_%H%M%S)
                  BACKUP_NAME="crystolia_backup_${TIMESTAMP}"
                  
                  echo "üîÑ Starting MongoDB backup: ${BACKUP_NAME}"
                  
                  # Create backup
                  mongodump --uri="${MONGO_URI}" --archive=/backup/${BACKUP_NAME}.gz --gzip
                  
                  # Upload to S3 (if AWS CLI available)
                  if command -v aws &> /dev/null && [ -n "${S3_BUCKET}" ]; then
                    aws s3 cp /backup/${BACKUP_NAME}.gz s3://${S3_BUCKET}/mongodb-backups/${BACKUP_NAME}.gz
                    echo "‚úÖ Backup uploaded to S3: s3://${S3_BUCKET}/mongodb-backups/${BACKUP_NAME}.gz"
                  else
                    echo "‚ö†Ô∏è S3 not configured, backup saved locally"
                  fi
                  
                  echo "‚úÖ Backup complete: ${BACKUP_NAME}"
              env:
                - name: MONGO_URI
                  value: {{ .Values.backend.env.MONGO_URI | quote }}
                - name: S3_BUCKET
                  value: {{ .Values.mongodb.backup.s3Bucket | default "" | quote }}
                - name: AWS_REGION
                  value: {{ .Values.mongodb.backup.awsRegion | default "us-east-1" | quote }}
              volumeMounts:
                - name: backup-volume
                  mountPath: /backup
          volumes:
            - name: backup-volume
              emptyDir: {}
{{- end }}
